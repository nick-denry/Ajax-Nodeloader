<?php

/**
 * @file
 * Allow load node title and body field without reloading site pages
 * via adding class "nodeloader" to your site links
 */


/**
 *  Add js and css for module
 */
function ajax_nodeloader_init() {
  drupal_add_css(drupal_get_path('module', 'ajax_nodeloader') . '/css/ajax_nodeloader.css');
  drupal_add_js(drupal_get_path('module', 'ajax_nodeloader') . '/js/ajax_nodeloader.js');
}


/**
 * Implements of ajax_nodeloader_hook_menu()
 */
function ajax_nodeloader_menu() {
  $items = array();

  $items['node_load/%ajax_nodeloader_url'] = array(
    'title' => 'load node via alias',
    'page callback' => 'ajax_nodeloader_load_node',
    'page arguments' => array(1),
    'load arguments' => array('%map','%index'),
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );

  $items['node_load/node/%ajax_nodeloader_url'] = array(
    'title' => 'load node',
    'page callback' => 'ajax_nodeloader_load_node',
    'page arguments' => array(2),
    'load arguments' => array('%map','%index'),
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );

  return $items;
}

/**
 * Use %wildcard_load to get dynamically
 * separated parts imploded into one string
 *   @see http://drupal.org/node/109153
 *   @see http://api.drupal.org/api/drupal/includes!menu.inc/function/menu_tail_to_arg/6
 */
function ajax_nodeloader_url_load($arg, $map, $index) {
    return implode("/", array_slice($map, $index));
}

/**
 * Implements of ajax_nodeloader_load_node()
 *
 * @nid
 *   Numeric node id or path alias
 */
function ajax_nodeloader_load_node($encoded_url) {
  /* init node loading */
  $output = FALSE;
  $delta = 0;

  if (!is_numeric($encoded_url)) {
    $system_path = drupal_lookup_path('source', $encoded_url);
    $path = split('/', $system_path);
    $nid = $path[1];
  }
  else {
    $nid = $encoded_url;
  }


  if ($nid != 0) {
    $node = node_load($nid);
  }

  if ($node) {
    $node_info = array();

    // set node id
    $node_info['nid'] = $nid;

    // set node title
    $node_info['title'] = $node->title;

    // Get other node fields (include body)
    $node_fields = field_info_fields(); // get all fields

    foreach($node_fields as $node_field) {
      // get ode field items
      $field_item = field_get_items('node', $node, $node_field['field_name'], $node->language);

      // if item not emty add it to array
      if ($field_item !== FALSE) {
        $node_info['fields'][$node_field['field_name']] = render(field_view_value('node', $node, $node_field['field_name'], $field_item[$delta]));
       }
    }

    $output = $node_info;
  }

  $result = drupal_json_encode($output);
  drupal_add_http_header('Content-Type', 'text/javascript; charset=utf-8');
  echo $result;

  return NULL;
}
