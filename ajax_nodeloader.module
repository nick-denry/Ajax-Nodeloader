<?php

/**
 * @file
 * Allow load node title and body field without reloading site pages
 * via adding class "nodeloader" to your site links
 */


/**
 *  Add js and css for module
 */
function ajax_nodeloader_init() {
  drupal_add_css(drupal_get_path('module', 'ajax_nodeloader') . '/css/ajax_nodeloader.css');
  drupal_add_js(drupal_get_path('module', 'ajax_nodeloader') . '/js/ajax_nodeloader.js');
}


/**
 * Implements of ajax_nodeloader_hook_menu()
 */
function ajax_nodeloader_menu() {
  $items = array();

  $items['node_load/node/%'] = array(
    'title' => 'load node',
    'page callback' => 'ajax_nodeloader_load_node',
    'page arguments' => array(2),
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );

  return $items;
}

/**
 * Implements of ajax_nodeloader_load_node()
 *
 * @nid
 *   Numeric node id or path alias
 */
function ajax_nodeloader_load_node($nid) {
  /* init node loading */
  $output = FALSE;
  $delta = 0;

  if (!is_numeric($nid)) {
    $system_path = drupal_lookup_path('source', $nid);
    $path = split('/', $system_path);
    if ($path[0] == 'node') {
      $nid = $path[1];
    }
    else {
      $nid = 0;
    }
  }

  if ($nid != 0) {
    $node = node_load($nid);
  }

  if ($node) {
    $node_info = array();
    $node_info['title'] = $node->title;
    // Get body filed value.
    //$body_field = field_get_items('node', $node, 'body', $node->language);
    $node_info['body'] = $node->body;//render(field_view_value('node', $node, 'body', $body_field[$delta]));

    $node_info['nid'] = $nid;
    $output = $node_info;
  }

  // Unfortunally, we need to use pure json_encode instead
  // drupal_to_js function to prevent wrong utf-8 json encoding
  // @see http://drupal.org/node/1086098
  // TODO json_encode for php < 5.2
  $result = json_encode($output);
  drupal_set_header('Content-Type: text/javascript; charset=utf-8');
  echo $result;

  return NULL;
}
